<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Escape.vim</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>" />
    <style>
        body {
            background-color: #1e1e2e;
            color: #cdd6f4;
            font-family: monospace, "Fira Code", "Courier New";
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            /* overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ë°©ì§€ëŠ” ì´ì œ #mazeì—ì„œ ì²˜ë¦¬ */
        }
        h1 {
            color: #89b4fa;
            margin-bottom: 20px;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            /* game-containerê°€ í™”ë©´ì˜ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            max-width: 95vw; 
            max-height: 95vh;
            justify-content: center; /* ë‚´ë¶€ ìš”ì†Œë¥¼ ì¤‘ì•™ ì •ë ¬ */
        }
        #maze {
            white-space: pre;
            background: #181825;
            padding: 10px; 
            border: 2px solid #89b4fa; 
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            box-sizing: border-box; 
            transition: width 0.3s ease, height 0.3s ease, font-size 0.3s ease; /* í°íŠ¸ í¬ê¸° ë³€ê²½ ì‹œì—ë„ ë¶€ë“œëŸ½ê²Œ */
            
            /* í•µì‹¬ ìˆ˜ì •: ë¯¸ë¡œ ìì²´ì˜ ìµœëŒ€ ë„ˆë¹„/ë†’ì´ë¥¼ ìœ ì—°í•˜ê²Œ ì„¤ì • */
            /* í°íŠ¸ í¬ê¸°ì— ë”°ë¼ ë¯¸ë¡œ ìì²´ì˜ width/heightê°€ ì¡°ì ˆë  ê²ƒì„ */
            /* ì—¬ê¸°ì„œ max-width/heightëŠ” ì „ì²´ í™”ë©´ì— ëŒ€í•œ ì œí•œì´ ì•„ë‹ˆë¼, 
               í˜¹ì‹œë¼ë„ ê³„ì‚°ëœ ê°’ì´ í™”ë©´ì„ ë„˜ì¹  ë•Œ fallback ì—­í•  */
            overflow: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ë°” ìë™ ìƒì„± */
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ ìœ ì—°í•˜ê²Œ ëŠ˜ì–´ë‚¨ */
            display: flex; /* ë‚´ë¶€ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš© */
            align-items: center;
            justify-content: center;
            text-align: left; /* ë¯¸ë¡œ í…ìŠ¤íŠ¸ ì™¼ìª½ ì •ë ¬ */
            line-height: 1; /* ê¸€ì ê°„ ì„¸ë¡œ ê°„ê²© 1ë¡œ ê³ ì •í•˜ì—¬ ë°€ì§‘ë„ë¥¼ ë†’ì„ */
        }
        #info {
            font-size: 14px;
            color: #a6adc8;
            text-align: center;
            white-space: nowrap; /* ì •ë³´ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        #main-menu, #game-screen {
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #282a36;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            /* ë©”ì¸ ë©”ë‰´ì™€ ê²Œì„ í™”ë©´ë„ í™”ë©´ ë¹„ìœ¨ì— ë§ì¶° ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ */
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }
        #main-menu.active, #game-screen.active {
            display: flex; 
        }
        .menu-button {
            background-color: #89b4fa;
            color: #1e1e2e;
            border: none;
            padding: 12px 25px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 200px;
        }
        .menu-button:hover {
            background-color: #74a0e8;
        }
        .setting-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-item label {
            width: 80px;
            text-align: right;
            font-size: 16px;
        }
        .setting-item input[type="number"], .setting-item select { 
            background-color: #3b3b4d;
            border: 1px solid #5a5a6d;
            color: #cdd6f4;
            padding: 8px;
            border-radius: 4px;
            width: 60px;
            text-align: center;
            font-size: 16px;
        }
        .setting-item select {
            width: 100px; 
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1 data-key="gameTitle">ğŸ§  Escape.vim</h1>

    <div id="main-menu" class="active">
        <h2 data-key="mainMenuTitle">ë©”ì¸ ë©”ë‰´</h2>
        <div class="setting-item">
            <label for="language-select" data-key="languageLabel">ì–¸ì–´:</label>
            <select id="language-select">
                <option value="ko">í•œêµ­ì–´</option>
                <option value="en">English</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="maze-width" data-key="widthLabel">ë„ˆë¹„:</label>
            <input type="number" id="maze-width" value="31" min="15" max="101" step="2"> 
        </div>
        <div class="setting-item">
            <label for="maze-height" data-key="heightLabel">ë†’ì´:</label>
            <input type="number" id="maze-height" value="21" min="15" max="101" step="2">
        </div>
        <div class="setting-item">
            <label for="font-size" data-key="fontSizeLabel">í°íŠ¸ í¬ê¸°:</label>
            <input type="number" id="font-size" value="14" min="10" max="30" step="1"> 
        </div>
        <button class="menu-button" id="start-game-button" data-key="startGameButton">ê²Œì„ ì‹œì‘</button>
        <p style="font-size: 12px; color: #a6adc8;" data-key="mazeSizeHint">* ë„ˆë¹„ì™€ ë†’ì´ëŠ” í™€ìˆ˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”! (í…Œë‘ë¦¬ í¬í•¨)</p>
    </div>

    <div id="game-screen">
        <div id="game-container">
            <div id="maze"></div>
            <div id="info" data-key="gameInfo">hjklë¡œ ì›€ì§ì—¬ | @ = ë„ˆ | X = ì¶œêµ¬</div>
        </div>
    </div>

    <script>
        let currentWidth = 31; 
        let currentHeight = 21;
        let currentFontSize = 14; 
        let player = { x: 0, y: 0 }; 
        let maze = [];
        let level = 1;
        let currentLanguage = "ko"; 

        const mainMenu = document.getElementById("main-menu");
        const gameScreen = document.getElementById("game-screen");
        const startGameButton = document.getElementById("start-game-button");
        const mazeWidthInput = document.getElementById("maze-width");
        const mazeHeightInput = document.getElementById("maze-height");
        const fontSizeInput = document.getElementById("font-size"); 
        const mazeElement = document.getElementById("maze");
        const languageSelect = document.getElementById("language-select"); 

        // --- ì–¸ì–´ ë²ˆì—­ ë°ì´í„° ---
        const translations = {
            ko: {
                gameTitle: "ğŸ§  Escape.vim",
                mainMenuTitle: "ë©”ì¸ ë©”ë‰´",
                languageLabel: "ì–¸ì–´:",
                widthLabel: "ë„ˆë¹„:",
                heightLabel: "ë†’ì´:",
                fontSizeLabel: "í°íŠ¸ í¬ê¸°:",
                startGameButton: "ê²Œì„ ì‹œì‘",
                mazeSizeHint: "* ë„ˆë¹„ì™€ ë†’ì´ëŠ” í™€ìˆ˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”! (í…Œë‘ë¦¬ í¬í•¨)",
                gameInfo: "hjklë¡œ ì›€ì§ì—¬ | @ = ë„ˆ | X = ì¶œêµ¬",
                levelClear: "ğŸ‰ ë ˆë²¨ {level} í´ë¦¬ì–´!", 
                alertPrefix: "" 
            },
            en: {
                gameTitle: "ğŸ§  Escape.vim",
                mainMenuTitle: "Main Menu",
                languageLabel: "Language:",
                widthLabel: "Width:",
                heightLabel: "Height:",
                fontSizeLabel: "Font Size:",
                startGameButton: "Start Game",
                mazeSizeHint: "* Width and height must be odd numbers! (Including border)",
                gameInfo: "Move with hjkl | @ = You | X = Exit",
                levelClear: "ğŸ‰ Level {level} Cleared!",
                alertPrefix: "Awesome! " 
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            const elements = document.querySelectorAll("[data-key]"); 
            elements.forEach(element => {
                const key = element.getAttribute("data-key");
                if (translations[lang] && translations[lang][key]) {
                    element.innerText = translations[lang][key];
                }
            });
        }

        function createEmptyMaze(w, h) {
            const m = Array.from({ length: h }, (_, y) =>
                Array.from({ length: w }, (_, x) => '#')
            );
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    m[y][x] = '#'; 
                }
            }
            return m;
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function generatePrimMaze(w, h) {
            const m = createEmptyMaze(w, h);
            
            let startX = 1; 
            let startY = 1; 

            m[startY][startX] = ' ';
            const walls = [];

            const directions = [[0, -1], [0, 1], [-1, 0], [1, 0]]; 
            for (const [dx, dy] of directions) {
                const wx = startX + dx; 
                const wy = startY + dy; 
                if (wy > 0 && wy < h - 1 && wx > 0 && wx < w - 1 && m[wy][wx] === '#') {
                    walls.push({ x: wx, y: wy });
                }
            }

            while (walls.length > 0) {
                const randomIndex = Math.floor(Math.random() * walls.length);
                const wall = walls.splice(randomIndex, 1)[0]; 

                let cx = wall.x; 
                let cy = wall.y; 

                let nx, ny;
                
                let connectedToPath = false;
                for (const [dx, dy] of directions) {
                    const px = cx + dx; 
                    const py = cy + dy;

                    if (py > 0 && py < h - 1 && px > 0 && px < w - 1 && m[py][px] === ' ') {
                        nx = cx + (cx - px); 
                        ny = cy + (cy - py);
                        connectedToPath = true;
                        break;
                    }
                }

                if (connectedToPath && ny > 0 && ny < h - 1 && nx > 0 && nx < w - 1 && m[ny][nx] === '#') {
                    m[cy][cx] = ' '; 
                    m[ny][nx] = ' '; 

                    for (const [dx, dy] of directions) {
                        const newWallX = nx + dx;
                        const newWallY = ny + dy;
                        if (newWallY > 0 && newWallY < h - 1 && newWallX > 0 && newWallX < w - 1 && 
                            m[newWallY][newWallX] === '#' && 
                            !walls.some(wall => wall.x === newWallX && wall.y === newWallY)) {
                            walls.push({ x: newWallX, y: newWallY });
                        }
                    }
                }
            }
            
            return m;
        }

        function drawMaze() {
            const view = maze.map((row, y) =>
                row.map((ch, x) => (x === player.x && y === player.y ? '@' : ch)).join('')
            ).join('\n');
            mazeElement.innerText = view;

            mazeElement.style.fontFamily = 'monospace';
            mazeElement.style.fontSize = `${currentFontSize}px`;
            // line-heightë¥¼ 1ë¡œ ê³ ì •í•˜ì—¬ í…ìŠ¤íŠ¸ê°€ ìœ„ì•„ë˜ë¡œ ë„ˆë¬´ ë²Œì–´ì§€ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
            mazeElement.style.lineHeight = `1`; 

            // CSSì˜ flexboxì™€ max-width/heightì— ë§¡ê²¨ì„œ ë™ì ìœ¼ë¡œ í¬ê¸° ì¡°ì ˆë˜ë„ë¡ í•©ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ë¯¸ë¡œì˜ ì‹¤ì œ ë¬¸ìì—´ ê¸¸ì´ì— ë”°ë¼ ë„ˆë¹„ë¥¼ ë§ì¶¥ë‹ˆë‹¤.
            mazeElement.style.width = 'auto'; // CSSê°€ ì¡°ì ˆí•˜ë„ë¡ autoë¡œ ì„¤ì •
            mazeElement.style.height = 'auto'; // CSSê°€ ì¡°ì ˆí•˜ë„ë¡ autoë¡œ ì„¤ì •
        }

        // ìƒˆë¡œìš´ ë ˆë²¨ ì‹œì‘ ë° ë¯¸ë¡œ í¬ê¸° ê³„ì‚° ë¡œì§ ê°œì„ 
        function newLevel(desiredWidth, desiredHeight) {
            // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë„ˆë¹„/ë†’ì´ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘í•˜ë˜, í™€ìˆ˜ì¸ì§€ í™•ì¸
            let baseWidth = desiredWidth % 2 === 0 ? desiredWidth + 1 : desiredWidth;
            let baseHeight = desiredHeight % 2 === 0 ? desiredHeight + 1 : desiredHeight;

            // ìµœì†Œ í¬ê¸° ë³´ì¥ (15x15)
            baseWidth = Math.max(15, baseWidth);
            baseHeight = Math.max(15, baseHeight);

            // í˜„ì¬ í°íŠ¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ í™”ë©´ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë¯¸ë¡œ ì¹¸ ìˆ˜ ê³„ì‚°
            // charWidth, charHeightëŠ” monospace í°íŠ¸ì˜ ëŒ€ëµì ì¸ ë¹„ìœ¨ (ì¡°ì ˆ ê°€ëŠ¥)
            const charWidthRatio = 0.6; // í°íŠ¸ í¬ê¸° ëŒ€ë¹„ ê¸€ì ë„ˆë¹„ ë¹„ìœ¨
            const charHeightRatio = 1.1; // í°íŠ¸ í¬ê¸° ëŒ€ë¹„ ê¸€ì ë†’ì´ ë¹„ìœ¨ (line-heightê°€ 1ë¡œ ë°”ë€Œì–´ì„œ ì´ ê°’ì€ ëœ ì¤‘ìš”)

            // ì „ì²´ ê²Œì„ ì»¨í…Œì´ë„ˆê°€ ì°¨ì§€í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ê³µê°„ (ì˜ˆ: í™”ë©´ì˜ 95%)
            const maxContentWidthPx = window.innerWidth * 0.90; // ë¯¸ë¡œê°€ ì°¨ì§€í•  ì‹¤ì œ í”½ì…€ ë„ˆë¹„ (ì—¬ë°± ê³ ë ¤)
            const maxContentHeightPx = window.innerHeight * 0.70; // ë¯¸ë¡œê°€ ì°¨ì§€í•  ì‹¤ì œ í”½ì…€ ë†’ì´ (ì œëª©, ë²„íŠ¼ ë“± ê³ ë ¤)
            
            const paddingAndBorderWidth = (10 * 2) + (2 * 2); // ì¢Œìš° íŒ¨ë”©+ë³´ë”
            const paddingAndBorderHeight = (10 * 2) + (2 * 2); // ìƒí•˜ íŒ¨ë”©+ë³´ë”

            // í°íŠ¸ í¬ê¸° + íŒ¨ë”©/ë³´ë”ë¥¼ ëº€ ìˆœìˆ˜ ë¯¸ë¡œ ê³µê°„ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ì¹¸ ìˆ˜
            let maxColsByScreen = Math.floor((maxContentWidthPx - paddingAndBorderWidth) / (currentFontSize * charWidthRatio));
            let maxRowsByScreen = Math.floor((maxContentHeightPx - paddingAndBorderHeight) / (currentFontSize * charHeightRatio)); // line-heightê°€ 1ì´ë¯€ë¡œ charHeightRatioë„ ì¡°ì ˆ ê³ ë ¤

            // í™€ìˆ˜ ê°•ì œ (ìµœëŒ€ ì¹¸ ìˆ˜ë„ í™€ìˆ˜ë¡œ ë§ì¶°ì•¼ í•¨)
            maxColsByScreen = maxColsByScreen % 2 === 0 ? maxColsByScreen - 1 : maxColsByScreen;
            maxRowsByScreen = maxRowsByScreen % 2 === 0 ? maxRowsByScreen - 1 : maxRowsByScreen;

            // ìµœì†Œ í¬ê¸° (15) ë³´ì¥
            maxColsByScreen = Math.max(15, maxColsByScreen);
            maxRowsByScreen = Math.max(15, maxRowsByScreen);


            // ìµœì¢… ë¯¸ë¡œ í¬ê¸°ëŠ” ì‚¬ìš©ì ì…ë ¥ ê¸°ë°˜ í¬ê¸°ì™€ í™”ë©´ ìµœëŒ€ í¬ê¸° ì¤‘ ì‘ì€ ê°’
            currentWidth = Math.min(baseWidth, maxColsByScreen);
            currentHeight = Math.min(baseHeight, maxRowsByScreen);

            // ë¯¸ë¡œ í¬ê¸°ê°€ ë„ˆë¬´ ì‘ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì¶”ê°€ ë³´ì • (ì„ íƒì )
            // ì˜ˆë¥¼ ë“¤ì–´, í°íŠ¸ê°€ ë„ˆë¬´ ì»¤ì„œ maxColsByScreenì´ 15ë³´ë‹¤ ì‘ì•„ì§€ë©´ 15ë¡œ ê³ ì •
            currentWidth = Math.max(15, currentWidth);
            currentHeight = Math.max(15, currentHeight);
            
            // ì…ë ¥ í•„ë“œì— ìµœì¢… ì ìš©ëœ ê°’ ë°˜ì˜ (ì‚¬ìš©ìê°€ ì„¤ì •í•œ ê°’ì€ ìœ ì§€í•˜ë˜, ì‹¤ì œ ë¯¸ë¡œ í¬ê¸°ëŠ” ì¡°ì ˆë¨ì„ ì‹œì‚¬)
            mazeWidthInput.value = desiredWidth;
            mazeHeightInput.value = desiredHeight;

            maze = generatePrimMaze(currentWidth, currentHeight); 
            player = { x: 1, y: 1 }; 
            maze[currentHeight - 2][currentWidth - 2] = 'X'; 
            
            drawMaze(); 
        }

        document.addEventListener("keydown", e => {
            if (!gameScreen.classList.contains('active')) return; 

            let dx = 0, dy = 0; 

            if (e.key === 'h') dx = -1; 
            else if (e.key === 'l') dx = 1;  
            else if (e.key === 'j') dy = 1;  
            else if (e.key === 'k') dy = -1; 
            else return; 

            const nx = player.x + dx; 
            const ny = player.y + dy; 

            if (ny >= 0 && ny < maze.length && nx >= 0 && nx < maze[0].length && maze[ny][nx] !== '#') {
                player.x = nx;
                player.y = ny;

                if (maze[ny][nx] === 'X') {
                    const alertMsg = translations[currentLanguage].levelClear.replace("{level}", level);
                    const alertPrefix = translations[currentLanguage].alertPrefix;
                    alert(alertPrefix + alertMsg);
                    level++;
                    // ë‹¤ìŒ ë ˆë²¨ì—ì„œ ë¯¸ë¡œ í¬ê¸°ë¥¼ ëŠ˜ë¦´ ë•Œ, í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë¯¸ë¡œ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¦ë¶„
                    newLevel(currentWidth + 4, currentHeight + 2); 
                } else {
                    drawMaze(); 
                }
            }
        });

        startGameButton.addEventListener("click", () => {
            let widthValue = parseInt(mazeWidthInput.value);
            let heightValue = parseInt(mazeHeightInput.value);
            let fontSizeValue = parseInt(fontSizeInput.value);

            // í°íŠ¸ í¬ê¸°, ë„ˆë¹„/ë†’ì´ ì…ë ¥ê°’ ì œí•œì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì‚¬ìš©ì ì…ë ¥ í•„ë“œì˜ min/max)
            currentFontSize = Math.max(10, Math.min(30, fontSizeValue)); 
            fontSizeInput.value = currentFontSize; // ì‹¤ì œ ì ìš©ëœ í°íŠ¸ í¬ê¸° ë°˜ì˜

            mainMenu.classList.remove('active'); 
            gameScreen.classList.add('active');   
            level = 1; 
            // ìƒˆë¡œìš´ ë ˆë²¨ ì‹œì‘ ì‹œ ì‚¬ìš©ì ì…ë ¥ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ newLevel í˜¸ì¶œ
            newLevel(widthValue, heightValue); 
        });

        languageSelect.addEventListener("change", (event) => {
            setLanguage(event.target.value);
        });

        languageSelect.value = currentLanguage; 
        setLanguage(currentLanguage); 
        mainMenu.classList.add('active');
    </script>
</body>
</html>
